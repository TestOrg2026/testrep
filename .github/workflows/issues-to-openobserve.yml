name: GitHub Issues â†’ OpenObserve

on:
  issues:
    types: [opened, edited, deleted, closed, reopened, assigned, unassigned, labeled, unlabeled, locked, unlocked, transferred, pinned, unpinned, milestoned, demilestoned]
  issue_comment:
    types: [created, edited, deleted]

jobs:
  capture:
    runs-on: ubuntu-latest

    steps:
      - name: Send complete payload to OpenObserve
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          EVENT_PAYLOAD: ${{ toJson(github.event) }}
        run: |
          # Create comprehensive payload with all GitHub context and event data
          cat > payload.json << 'EOF'
          {
            "workflow_metadata": {
              "event_name": "${{ github.event_name }}",
              "action": "${{ github.event.action }}",
              "workflow": "${{ github.workflow }}",
              "run_id": "${{ github.run_id }}",
              "run_number": "${{ github.run_number }}",
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            },
            "repository": {
              "id": "${{ github.event.repository.id }}",
              "node_id": "${{ github.event.repository.node_id }}",
              "name": "${{ github.event.repository.name }}",
              "full_name": "${{ github.event.repository.full_name }}",
              "private": "${{ github.event.repository.private }}",
              "owner": {
                "login": "${{ github.event.repository.owner.login }}",
                "id": "${{ github.event.repository.owner.id }}",
                "node_id": "${{ github.event.repository.owner.node_id }}",
                "type": "${{ github.event.repository.owner.type }}",
                "site_admin": "${{ github.event.repository.owner.site_admin }}"
              },
              "html_url": "${{ github.event.repository.html_url }}",
              "description": "${{ github.event.repository.description }}",
              "fork": "${{ github.event.repository.fork }}",
              "created_at": "${{ github.event.repository.created_at }}",
              "updated_at": "${{ github.event.repository.updated_at }}",
              "pushed_at": "${{ github.event.repository.pushed_at }}",
              "size": "${{ github.event.repository.size }}",
              "stargazers_count": "${{ github.event.repository.stargazers_count }}",
              "watchers_count": "${{ github.event.repository.watchers_count }}",
              "language": "${{ github.event.repository.language }}",
              "forks_count": "${{ github.event.repository.forks_count }}",
              "open_issues_count": "${{ github.event.repository.open_issues_count }}",
              "default_branch": "${{ github.event.repository.default_branch }}",
              "visibility": "${{ github.event.repository.visibility }}"
            },
            "organization": {
              "login": "${{ github.event.organization.login }}",
              "id": "${{ github.event.organization.id }}",
              "node_id": "${{ github.event.organization.node_id }}",
              "url": "${{ github.event.organization.url }}",
              "repos_url": "${{ github.event.organization.repos_url }}",
              "events_url": "${{ github.event.organization.events_url }}",
              "hooks_url": "${{ github.event.organization.hooks_url }}",
              "issues_url": "${{ github.event.organization.issues_url }}",
              "members_url": "${{ github.event.organization.members_url }}",
              "public_members_url": "${{ github.event.organization.public_members_url }}",
              "description": "${{ github.event.organization.description }}"
            },
            "issue": {
              "id": "${{ github.event.issue.id }}",
              "node_id": "${{ github.event.issue.node_id }}",
              "number": "${{ github.event.issue.number }}",
              "title": "${{ github.event.issue.title }}",
              "user": {
                "login": "${{ github.event.issue.user.login }}",
                "id": "${{ github.event.issue.user.id }}",
                "node_id": "${{ github.event.issue.user.node_id }}",
                "type": "${{ github.event.issue.user.type }}",
                "site_admin": "${{ github.event.issue.user.site_admin }}"
              },
              "state": "${{ github.event.issue.state }}",
              "locked": "${{ github.event.issue.locked }}",
              "assignees": ${{ toJson(github.event.issue.assignees) }},
              "labels": ${{ toJson(github.event.issue.labels) }},
              "comments": "${{ github.event.issue.comments }}",
              "created_at": "${{ github.event.issue.created_at }}",
              "updated_at": "${{ github.event.issue.updated_at }}",
              "closed_at": "${{ github.event.issue.closed_at }}",
              "author_association": "${{ github.event.issue.author_association }}",
              "body": "${{ github.event.issue.body }}"
            },
            "comment": {
              "id": "${{ github.event.comment.id }}",
              "node_id": "${{ github.event.comment.node_id }}",
              "user": {
                "login": "${{ github.event.comment.user.login }}",
                "id": "${{ github.event.comment.user.id }}",
                "node_id": "${{ github.event.comment.user.node_id }}",
                "type": "${{ github.event.comment.user.type }}",
                "site_admin": "${{ github.event.comment.user.site_admin }}"
              },
              "created_at": "${{ github.event.comment.created_at }}",
              "updated_at": "${{ github.event.comment.updated_at }}",
              "author_association": "${{ github.event.comment.author_association }}",
              "body": "${{ github.event.comment.body }}"
            },
            "sender": {
              "login": "${{ github.event.sender.login }}",
              "id": "${{ github.event.sender.id }}",
              "node_id": "${{ github.event.sender.node_id }}",
              "type": "${{ github.event.sender.type }}",
              "site_admin": "${{ github.event.sender.site_admin }}"
            },
            "assignee": {
              "login": "${{ github.event.assignee.login }}",
              "id": "${{ github.event.assignee.id }}",
              "node_id": "${{ github.event.assignee.node_id }}",
              "type": "${{ github.event.assignee.type }}",
              "site_admin": "${{ github.event.assignee.site_admin }}"
            },
            "label": {
              "id": "${{ github.event.label.id }}",
              "node_id": "${{ github.event.label.node_id }}",
              "name": "${{ github.event.label.name }}",
              "color": "${{ github.event.label.color }}",
              "description": "${{ github.event.label.description }}"
            },
            "changes": ${{ toJson(github.event.changes) }}
          }
          EOF

          # Clean up empty or null fields
          jq 'walk(if type == "object" then with_entries(select(.value != "" and .value != null and .value != "null")) else . end)' payload.json > cleaned_payload.json

      - name: Send to OpenObserve
        run: |
          curl -X POST "${{ secrets.OO_INGEST_URL }}" \
            -H "Authorization: Basic ${{ secrets.OO_AUTH }}" \
            -H "Content-Type: application/json" \
            -d @cleaned_payload.json

      - name: Log payload for debugging (optional)
        if: ${{ github.event_name == 'workflow_dispatch' || false }}
        run: |
          echo "=== Sent Payload ==="
          cat cleaned_payload.json
